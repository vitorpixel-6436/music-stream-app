{% extends 'music/base.html' %}
{% load static %}

{% block title %}Upload Music - Music Stream{% endblock %}

{% block breadcrumbs %}
<span class="spotify-breadcrumb-separator">›</span>
<div class="spotify-breadcrumb-item active">
    <i class="fas fa-upload"></i>
    <span>Upload</span>
</div>
{% endblock %}

{% block content %}

<!-- Spotify-style Header -->
<div class="spotify-section-header mb-12" data-fade-in>
    <div>
        <h1 class="spotify-section-title text-4xl lg:text-5xl mb-2">
            Upload Music
        </h1>
        <p class="spotify-section-subtitle text-base">
            Add your tracks to the library. Supports MP3, FLAC, WAV, and more.
        </p>
    </div>
</div>

<!-- Upload Form Container -->
<div class="max-w-4xl mx-auto space-y-8">
    
    <form method="post" enctype="multipart/form-data" id="upload-form" class="space-y-6">
        {% csrf_token %}
        
        <!-- Drag & Drop Zone (Spotify-minimal style) -->
        <div id="drop-zone" 
             class="spotify-card p-12 text-center cursor-pointer border-2 border-dashed border-white/10 hover:border-white/30 transition-all group"
             data-fade-in>
            
            <!-- Icon -->
            <div class="mb-6">
                <i class="fas fa-cloud-upload-alt text-6xl text-white/40 group-hover:text-white/60 transition-all duration-300"></i>
            </div>
            
            <!-- Text -->
            <h3 class="text-xl font-semibold mb-2">Drop your music files here</h3>
            <p class="text-sm text-white/60 mb-6">or click to browse your files</p>
            
            <!-- File Input (Hidden) -->
            <input type="file" 
                   name="file" 
                   id="file-input" 
                   accept=".mp3,.flac,.wav,.m4a,.ogg" 
                   class="hidden" 
                   required>
            
            <!-- Selected File Info -->
            <div id="file-info" 
                 class="inline-flex items-center gap-4 bg-white/5 px-6 py-3 rounded-lg opacity-0 transition-all duration-300">
                <i class="fas fa-music text-red-400"></i>
                <div class="text-left">
                    <p id="file-name" class="font-medium text-sm"></p>
                    <p id="file-size" class="text-xs text-white/60"></p>
                </div>
                <button type="button" 
                        id="clear-file" 
                        class="spotify-icon-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Supported Formats -->
            <div class="mt-6 flex items-center justify-center flex-wrap gap-2">
                <span class="spotify-pill text-xs">MP3</span>
                <span class="spotify-pill text-xs">FLAC</span>
                <span class="spotify-pill text-xs">WAV</span>
                <span class="spotify-pill text-xs">M4A</span>
                <span class="spotify-pill text-xs">OGG</span>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div id="upload-progress" 
             class="spotify-card p-6 opacity-0 transition-all duration-500">
            <div class="flex items-center justify-between mb-3">
                <span class="font-semibold text-sm">Uploading...</span>
                <span id="progress-percent" class="font-mono text-sm text-white/60">0%</span>
            </div>
            <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                <div id="progress-bar-inner" 
                     class="h-full bg-white transition-all duration-300" 
                     style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Form Fields (Minimal) -->
        <div class="spotify-card p-8 space-y-6" data-fade-in>
            
            <h3 class="text-lg font-semibold mb-4">Track Information</h3>
            
            <!-- Title -->
            <div class="space-y-2">
                <label for="title" class="block text-sm font-medium text-white/70">
                    Track Title *
                </label>
                <input type="text" 
                       name="title" 
                       id="title" 
                       placeholder="Enter track title" 
                       class="w-full bg-white/5 px-4 py-3 rounded-lg border border-white/10 focus:border-white/30 focus:bg-white/10 outline-none transition-all text-white placeholder:text-white/40"
                       required>
            </div>
            
            <!-- Artist -->
            <div class="space-y-2">
                <label for="artist" class="block text-sm font-medium text-white/70">
                    Artist Name *
                </label>
                <input type="text" 
                       name="artist" 
                       id="artist" 
                       placeholder="Enter artist name" 
                       class="w-full bg-white/5 px-4 py-3 rounded-lg border border-white/10 focus:border-white/30 focus:bg-white/10 outline-none transition-all text-white placeholder:text-white/40"
                       required>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Album -->
                <div class="space-y-2">
                    <label for="album" class="block text-sm font-medium text-white/70">
                        Album
                    </label>
                    <input type="text" 
                           name="album" 
                           id="album" 
                           placeholder="Optional" 
                           class="w-full bg-white/5 px-4 py-3 rounded-lg border border-white/10 focus:border-white/30 focus:bg-white/10 outline-none transition-all text-white placeholder:text-white/40">
                </div>
                
                <!-- Year -->
                <div class="space-y-2">
                    <label for="year" class="block text-sm font-medium text-white/70">
                        Year
                    </label>
                    <input type="number" 
                           name="year" 
                           id="year" 
                           placeholder="2024" 
                           min="1900" 
                           max="2100" 
                           class="w-full bg-white/5 px-4 py-3 rounded-lg border border-white/10 focus:border-white/30 focus:bg-white/10 outline-none transition-all text-white placeholder:text-white/40">
                </div>
            </div>
            
            <div class="spotify-divider"></div>
            
            <!-- Cover Image -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-white/70">
                    Album Cover
                </label>
                <div class="flex items-center gap-6">
                    <div id="cover-preview" 
                         class="w-24 h-24 rounded-lg overflow-hidden bg-white/5 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-image text-white/20 text-2xl"></i>
                    </div>
                    <div class="flex-1">
                        <label for="cover-input" 
                               class="inline-block px-6 py-2.5 bg-white/10 hover:bg-white/15 rounded-full text-sm font-semibold cursor-pointer transition-all">
                            Choose File
                        </label>
                        <p class="text-xs text-white/60 mt-2">JPG, PNG or WEBP • Max 5MB</p>
                    </div>
                </div>
                <input type="file" 
                       name="cover" 
                       id="cover-input" 
                       accept="image/*" 
                       class="hidden">
            </div>
            
            <div class="spotify-divider"></div>
            
            <!-- Genre Tags (Fixed: removed split filter) -->
            <div class="space-y-3">
                <label class="block text-sm font-medium text-white/70">
                    Genres
                </label>
                <div class="flex flex-wrap gap-2">
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Rock" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Rock</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Pop" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Pop</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Jazz" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Jazz</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Electronic" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Electronic</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Hip-Hop" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Hip-Hop</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Classical" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Classical</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="R&B" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">R&B</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Country" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Country</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Blues" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Blues</span>
                    </label>
                    <label class="genre-tag cursor-pointer">
                        <input type="checkbox" name="genres" value="Metal" class="hidden peer">
                        <span class="spotify-pill peer-checked:active text-sm">Metal</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-3" data-fade-in>
            <button type="submit" 
                    id="submit-btn" 
                    class="flex-1 bg-white text-black px-8 py-4 rounded-full font-bold hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                <i class="fas fa-check mr-2"></i>Upload Track
            </button>
            <a href="{% url 'music:index' %}" 
               class="px-8 py-4 bg-white/10 hover:bg-white/15 rounded-full font-bold transition-all hover:scale-105 active:scale-95 flex items-center justify-center">
                Cancel
            </a>
        </div>
        
    </form>
    
    <!-- Upload Tips (Spotify-style) -->
    <div class="spotify-card p-6" data-fade-in>
        <h3 class="text-base font-semibold mb-4 flex items-center gap-2">
            <i class="fas fa-lightbulb text-yellow-400"></i>
            Tips for better uploads
        </h3>
        <ul class="space-y-2 text-sm text-white/70">
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-green-400 mt-0.5"></i>
                <span>Use high-quality audio files (FLAC or 320kbps MP3) for best sound</span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-green-400 mt-0.5"></i>
                <span>Include album artwork for a better visual experience</span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-green-400 mt-0.5"></i>
                <span>Fill in all metadata fields to make your tracks easier to find</span>
            </li>
            <li class="flex items-start gap-3">
                <i class="fas fa-check text-green-400 mt-0.5"></i>
                <span>Make sure you have the rights to upload the music</span>
            </li>
        </ul>
    </div>
    
</div>

{% endblock %}

{% block extra_js %}
<script>
// Elements
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const clearFileBtn = document.getElementById('clear-file');
const coverInput = document.getElementById('cover-input');
const coverPreview = document.getElementById('cover-preview');
const uploadForm = document.getElementById('upload-form');
const submitBtn = document.getElementById('submit-btn');
const uploadProgress = document.getElementById('upload-progress');
const progressPercent = document.getElementById('progress-percent');
const progressBarInner = document.getElementById('progress-bar-inner');

// Click to open file dialog
dropZone.addEventListener('click', (e) => {
    if (!e.target.closest('#file-info')) {
        fileInput.click();
    }
});

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-white/50', 'bg-white/5');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-white/50', 'bg-white/5');
    }, false);
});

// Handle dropped files
dropZone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
}, false);

// Handle file selection from input
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileInfo.style.opacity = '1';
    
    // Auto-fill title from filename
    const titleInput = document.getElementById('title');
    if (!titleInput.value) {
        const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
        titleInput.value = fileNameWithoutExt;
    }
}

// Clear file selection
clearFileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.value = '';
    fileInfo.style.opacity = '0';
});

// Cover image preview
coverInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            coverPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="cover">`;
        };
        reader.readAsDataURL(file);
    }
});

// Form submission with progress
uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(uploadForm);
    
    // Show progress
    uploadProgress.style.opacity = '1';
    submitBtn.disabled = true;
    
    // Simulate upload progress (replace with actual AJAX upload)
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressBarInner.style.width = progress + '%';
        progressPercent.textContent = Math.round(progress) + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            // Actually submit the form after animation
            setTimeout(() => {
                uploadForm.submit();
            }, 500);
        }
    }, 200);
});

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}
