{% extends 'music/base.html' %}
{% load static %}

{% block title %}Upload Music - Music Stream{% endblock %}

{% block content %}

<!-- Upload Page Container -->
<div class="max-w-5xl mx-auto fade-in">
    
    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-5xl font-black gradient-text-red mb-4">
            ðŸš€ Upload Music
        </h1>
        <p class="text-lg text-white/50 max-w-2xl mx-auto">
            Add your tracks to the library. Supports MP3, FLAC, WAV, and more.
        </p>
    </div>
    
    <!-- Upload Form -->
    <form method="post" enctype="multipart/form-data" id="upload-form" class="space-y-8">
        {% csrf_token %}
        
        <!-- Drag & Drop Zone -->
        <div id="drop-zone" 
             class="glass relative overflow-hidden rounded-[48px] p-12 text-center cursor-pointer transition-all duration-500 hover:border-red-500/50 group">
            
            <!-- Background Animation -->
            <div class="absolute inset-0 bg-gradient-to-br from-red-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            
            <!-- Content -->
            <div class="relative z-10">
                <div class="mb-6">
                    <i class="fas fa-cloud-upload-alt text-7xl text-red-400 opacity-50 group-hover:opacity-100 transition-all duration-500 group-hover:scale-110"></i>
                </div>
                
                <h3 class="text-2xl font-bold mb-2">Drop your music files here</h3>
                <p class="text-white/40 mb-6">or click to browse</p>
                
                <!-- File Input (Hidden) -->
                <input type="file" 
                       name="file" 
                       id="file-input" 
                       accept=".mp3,.flac,.wav,.m4a,.ogg" 
                       class="hidden" 
                       required>
                
                <!-- Selected File Info -->
                <div id="file-info" class="glass-dark px-6 py-4 rounded-2xl inline-flex items-center gap-4 opacity-0 transition-all duration-300">
                    <i class="fas fa-music text-red-400 text-2xl"></i>
                    <div class="text-left">
                        <p id="file-name" class="font-semibold text-sm"></p>
                        <p id="file-size" class="text-xs text-white/40"></p>
                    </div>
                    <button type="button" 
                            id="clear-file" 
                            class="ml-4 w-8 h-8 rounded-full bg-white/10 hover:bg-red-500/20 flex items-center justify-center transition-all">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
                
                <!-- Supported Formats -->
                <div class="mt-8 flex items-center justify-center gap-3 text-xs text-white/30">
                    <span class="glass px-3 py-1 rounded-lg">MP3</span>
                    <span class="glass px-3 py-1 rounded-lg">FLAC</span>
                    <span class="glass px-3 py-1 rounded-lg">WAV</span>
                    <span class="glass px-3 py-1 rounded-lg">M4A</span>
                    <span class="glass px-3 py-1 rounded-lg">OGG</span>
                </div>
            </div>
        </div>
        
        <!-- Progress Bar (Initially Hidden) -->
        <div id="upload-progress" class="glass px-8 py-6 rounded-3xl opacity-0 transition-all duration-500">
            <div class="flex items-center justify-between mb-3">
                <span class="font-semibold">Uploading...</span>
                <span id="progress-percent" class="font-mono text-red-400">0%</span>
            </div>
            <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                <div id="progress-bar-inner" 
                     class="h-full bg-gradient-to-r from-red-600 to-red-400 shadow-glow-md transition-all duration-300" 
                     style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Form Fields Grid -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Title -->
            <div class="space-y-2">
                <label for="title" class="block text-sm font-semibold text-white/60">
                    <i class="fas fa-heading mr-2"></i>Track Title *
                </label>
                <input type="text" 
                       name="title" 
                       id="title" 
                       placeholder="Enter track title" 
                       class="w-full glass px-6 py-4 rounded-2xl bg-transparent border border-white/10 focus:border-red-500/50 outline-none transition-all text-white placeholder:text-white/30"
                       required>
            </div>
            
            <!-- Artist -->
            <div class="space-y-2">
                <label for="artist" class="block text-sm font-semibold text-white/60">
                    <i class="fas fa-user mr-2"></i>Artist Name *
                </label>
                <input type="text" 
                       name="artist" 
                       id="artist" 
                       placeholder="Enter artist name" 
                       class="w-full glass px-6 py-4 rounded-2xl bg-transparent border border-white/10 focus:border-red-500/50 outline-none transition-all text-white placeholder:text-white/30"
                       required>
            </div>
            
            <!-- Album -->
            <div class="space-y-2">
                <label for="album" class="block text-sm font-semibold text-white/60">
                    <i class="fas fa-compact-disc mr-2"></i>Album (Optional)
                </label>
                <input type="text" 
                       name="album" 
                       id="album" 
                       placeholder="Enter album name" 
                       class="w-full glass px-6 py-4 rounded-2xl bg-transparent border border-white/10 focus:border-red-500/50 outline-none transition-all text-white placeholder:text-white/30">
            </div>
            
            <!-- Year -->
            <div class="space-y-2">
                <label for="year" class="block text-sm font-semibold text-white/60">
                    <i class="fas fa-calendar mr-2"></i>Year (Optional)
                </label>
                <input type="number" 
                       name="year" 
                       id="year" 
                       placeholder="2024" 
                       min="1900" 
                       max="2100" 
                       class="w-full glass px-6 py-4 rounded-2xl bg-transparent border border-white/10 focus:border-red-500/50 outline-none transition-all text-white placeholder:text-white/30">
            </div>
        </div>
        
        <!-- Cover Image Upload -->
        <div class="space-y-2">
            <label for="cover" class="block text-sm font-semibold text-white/60">
                <i class="fas fa-image mr-2"></i>Cover Image (Optional)
            </label>
            <div class="glass px-6 py-4 rounded-2xl flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div id="cover-preview" class="w-16 h-16 rounded-xl overflow-hidden bg-gradient-to-br from-red-900/30 to-black flex items-center justify-center">
                        <i class="fas fa-image text-white/20 text-xl"></i>
                    </div>
                    <div>
                        <p class="font-medium text-sm">Album Cover</p>
                        <p class="text-xs text-white/40">JPG, PNG or WEBP</p>
                    </div>
                </div>
                <label for="cover-input" class="glass-red px-6 py-2 rounded-xl font-semibold text-sm cursor-pointer hover:scale-105 active:scale-95 transition-all">
                    <i class="fas fa-upload mr-2"></i>Choose File
                </label>
                <input type="file" 
                       name="cover" 
                       id="cover-input" 
                       accept="image/*" 
                       class="hidden">
            </div>
        </div>
        
        <!-- Genre Tags (Optional) -->
        <div class="space-y-2">
            <label class="block text-sm font-semibold text-white/60">
                <i class="fas fa-tags mr-2"></i>Genre Tags
            </label>
            <div class="glass px-6 py-4 rounded-2xl flex flex-wrap gap-2">
                {% for genre in "Rock,Pop,Jazz,Electronic,Hip-Hop,Classical,R&B,Country"|split:"," %}
                <label class="genre-tag cursor-pointer">
                    <input type="checkbox" name="genres" value="{{ genre }}" class="hidden peer">
                    <span class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-sm transition-all peer-checked:bg-red-500/20 peer-checked:border-red-500/50 peer-checked:text-red-400 hover:bg-white/10 inline-block">
                        {{ genre }}
                    </span>
                </label>
                {% endfor %}
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="flex gap-4">
            <button type="submit" 
                    id="submit-btn" 
                    class="flex-1 glass-red px-8 py-5 rounded-2xl font-bold text-lg shadow-glow-md hover:shadow-glow-lg hover:scale-[1.02] active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-cloud-upload-alt mr-3"></i>Upload Track
            </button>
            <a href="{% url 'music:index' %}" 
               class="glass px-8 py-5 rounded-2xl font-bold text-lg hover:bg-white/10 transition-all hover:scale-[1.02] active:scale-95 flex items-center justify-center">
                <i class="fas fa-times mr-3"></i>Cancel
            </a>
        </div>
        
    </form>
    
</div>

{% endblock %}

{% block extra_js %}
<script>
// Elements
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
const fileInfo = document.getElementById('file-info');
const fileName = document.getElementById('file-name');
const fileSize = document.getElementById('file-size');
const clearFileBtn = document.getElementById('clear-file');
const coverInput = document.getElementById('cover-input');
const coverPreview = document.getElementById('cover-preview');
const uploadForm = document.getElementById('upload-form');
const submitBtn = document.getElementById('submit-btn');
const uploadProgress = document.getElementById('upload-progress');
const progressPercent = document.getElementById('progress-percent');
const progressBarInner = document.getElementById('progress-bar-inner');

// Click to open file dialog
dropZone.addEventListener('click', () => fileInput.click());

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-red-500', 'border-2');
    }, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-red-500', 'border-2');
    }, false);
});

// Handle dropped files
dropZone.addEventListener('drop', (e) => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
}, false);

// Handle file selection from input
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileInfo.style.opacity = '1';
    
    // Auto-fill title from filename
    const titleInput = document.getElementById('title');
    if (!titleInput.value) {
        const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
        titleInput.value = fileNameWithoutExt;
    }
}

// Clear file selection
clearFileBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.value = '';
    fileInfo.style.opacity = '0';
});

// Cover image preview
coverInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            coverPreview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover" alt="cover">`;
        };
        reader.readAsDataURL(file);
    }
});

// Form submission with progress
uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(uploadForm);
    
    // Show progress
    uploadProgress.style.opacity = '1';
    submitBtn.disabled = true;
    
    // Simulate upload progress (replace with actual AJAX upload)
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 100) progress = 100;
        
        progressBarInner.style.width = progress + '%';
        progressPercent.textContent = Math.round(progress) + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            // Actually submit the form after animation
            setTimeout(() => {
                uploadForm.submit();
            }, 500);
        }
    }, 200);
});

// Helper function to format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}
</script>
{% endblock %}
