{% extends 'music/base.html' %}
{% load static %}

{% block title %}Music Library - Music Stream{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/steam-cards.css' %}">
<link rel="stylesheet" href="{% static 'css/steam-carousel.css' %}">
{% endblock %}

{% block content %}

<!-- Featured Banner (Hero) -->
{% if music_files %}
<section class="max-w-[1920px] mx-auto mb-16" data-glass-context>
    <div class="steam-featured" data-track-id="{{ music_files.0.pk }}" data-album-id="1">
        <!-- Background Image -->
        <div class="steam-featured-bg">
            {% if music_files.0.cover_image %}
            <img src="{{ music_files.0.cover_image.url }}" 
                 alt="{{ music_files.0.title }}" 
                 class="steam-featured-image">
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-red-900/50 to-black"></div>
            {% endif %}
        </div>
        
        <!-- Gradient Overlay -->
        <div class="steam-featured-overlay"></div>
        
        <!-- Content -->
        <div class="steam-featured-content">
            <div class="steam-featured-label">
                <i class="fas fa-star"></i>
                FEATURED TRACK
            </div>
            
            <h1 class="steam-featured-title">{{ music_files.0.title }}</h1>
            <p class="steam-featured-artist">{{ music_files.0.artist.name }}</p>
            <p class="steam-featured-description">
                Experience high-quality audio streaming with crystal clear sound. 
                Listen now and add to your collection.
            </p>
            
            <div class="steam-featured-actions">
                <a href="{% url 'music:player' music_files.0.pk %}" class="steam-featured-btn steam-featured-btn-primary">
                    <i class="fas fa-play"></i>
                    Play Now
                </a>
                <a href="{% url 'music:download' music_files.0.pk %}" class="steam-featured-btn steam-featured-btn-secondary">
                    <i class="fas fa-download"></i>
                    Download
                </a>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Category Pills -->
<section class="max-w-[1920px] mx-auto mb-8">
    <div class="steam-category-pills">
        <button class="steam-category-pill active" data-category="all">
            <i class="fas fa-fire mr-2"></i>All Tracks
        </button>
        <button class="steam-category-pill" data-category="recent">
            <i class="fas fa-clock mr-2"></i>Recent
        </button>
        <button class="steam-category-pill" data-category="popular">
            <i class="fas fa-chart-line mr-2"></i>Popular
        </button>
        {% for artist in all_artists|slice:":5" %}
        <button class="steam-category-pill" data-category="artist-{{ artist.id }}">
            <i class="fas fa-user mr-2"></i>{{ artist.name }}
        </button>
        {% endfor %}
    </div>
</section>

<!-- Carousel: Recently Added -->
{% if music_files|slice:":6" %}
<section class="max-w-[1920px] mx-auto steam-carousel-section" data-glass-context>
    <div class="steam-carousel-header">
        <h2 class="steam-carousel-title">
            <i class="fas fa-clock"></i>
            Recently Added
        </h2>
        <div class="steam-carousel-nav">
            <button class="steam-carousel-arrow" data-carousel-prev aria-label="Previous">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="steam-carousel-arrow" data-carousel-next aria-label="Next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="steam-carousel-wrapper">
        <div class="steam-carousel">
            {% for track in music_files|slice:":12" %}
            <div class="steam-carousel-item">
                <div class="steam-carousel-card" data-track-id="{{ track.pk }}">
                    {% if track.cover_image %}
                    <img src="{{ track.cover_image.url }}" 
                         alt="{{ track.title }}" 
                         class="steam-carousel-card-image">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-red-900/30 to-black flex items-center justify-center">
                        <i class="fas fa-music text-5xl text-white/20"></i>
                    </div>
                    {% endif %}
                    
                    <div class="steam-carousel-card-overlay">
                        <h3 class="steam-carousel-card-title">{{ track.title }}</h3>
                        <p class="steam-carousel-card-artist">{{ track.artist.name }}</p>
                    </div>
                    
                    <div class="steam-carousel-card-play">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="steam-carousel-progress">
            <div class="steam-carousel-progress-bar"></div>
        </div>
    </div>
</section>
{% endif %}

<!-- Carousel: Popular Tracks -->
{% if music_files|slice:"6:" %}
<section class="max-w-[1920px] mx-auto steam-carousel-section" data-glass-context>
    <div class="steam-carousel-header">
        <h2 class="steam-carousel-title">
            <i class="fas fa-fire"></i>
            Trending Now
        </h2>
        <div class="steam-carousel-nav">
            <button class="steam-carousel-arrow" data-carousel-prev aria-label="Previous">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="steam-carousel-arrow" data-carousel-next aria-label="Next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <div class="steam-carousel-wrapper">
        <div class="steam-carousel">
            {% for track in music_files|slice:"6:18" %}
            <div class="steam-carousel-item">
                <div class="steam-carousel-card" data-track-id="{{ track.pk }}">
                    {% if track.cover_image %}
                    <img src="{{ track.cover_image.url }}" 
                         alt="{{ track.title }}" 
                         class="steam-carousel-card-image">
                    {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-blue-900/30 to-black flex items-center justify-center">
                        <i class="fas fa-music text-5xl text-white/20"></i>
                    </div>
                    {% endif %}
                    
                    <div class="steam-carousel-card-overlay">
                        <h3 class="steam-carousel-card-title">{{ track.title }}</h3>
                        <p class="steam-carousel-card-artist">{{ track.artist.name }}</p>
                    </div>
                    
                    <div class="steam-carousel-card-play">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="steam-carousel-progress">
            <div class="steam-carousel-progress-bar"></div>
        </div>
    </div>
</section>
{% endif %}

<!-- Main Section Header -->
<section class="max-w-[1920px] mx-auto mb-8 mt-16">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <h2 class="text-3xl font-bold flex items-center gap-3">
            <i class="fas fa-grip text-red-500"></i>
            {% if search_query %}Search Results{% else %}All Tracks{% endif %}
        </h2>
        
        <!-- Search & Filter Controls -->
        <div class="flex flex-wrap gap-3">
            <!-- Search Bar -->
            <form action="{% url 'music:index' %}" method="get" class="flex gap-2">
                <div class="glass-layer-2 glass-radius-xl px-4 py-2 flex items-center gap-2 min-w-[250px]">
                    <i class="fas fa-search text-white/40"></i>
                    <input 
                        type="text" 
                        name="q" 
                        value="{{ search_query }}" 
                        placeholder="Search..." 
                        class="bg-transparent border-none outline-none text-sm w-full placeholder:text-white/30 text-white"
                    >
                </div>
                <button type="submit" class="glass-red-tint glass-radius-xl glass-pressable px-4 py-2">
                    <i class="fas fa-search"></i>
                </button>
            </form>
            
            <!-- Sort Filter -->
            <form action="{% url 'music:index' %}" method="get">
                <div class="glass-layer-2 glass-radius-xl px-4 py-2 flex items-center gap-2">
                    <i class="fas fa-sort text-white/40"></i>
                    <select name="sort" 
                            class="bg-transparent border-none outline-none text-sm cursor-pointer text-white"
                            onchange="this.form.submit()">
                        <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest</option>
                        <option value="title" {% if sort_by == 'title' %}selected{% endif %}>A-Z</option>
                        <option value="-title" {% if sort_by == '-title' %}selected{% endif %}>Z-A</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Steam Grid -->
<section class="max-w-[1920px] mx-auto mb-20">
    <div class="steam-grid">
        {% for track in music_files %}
        <div class="steam-card" data-track-id="{{ track.pk }}" data-glass-context>
            <!-- Cover Image -->
            <div class="steam-card-cover">
                {% if track.cover_image %}
                <img src="{{ track.cover_image.url }}" 
                     alt="{{ track.title }}" 
                     class="steam-card-image">
                {% else %}
                <div class="w-full h-full bg-gradient-to-br from-red-900/30 to-black flex items-center justify-center">
                    <i class="fas fa-music text-6xl text-white/20"></i>
                </div>
                {% endif %}
            </div>
            
            <!-- Gradient Overlay -->
            <div class="steam-card-overlay"></div>
            
            <!-- Quick Actions -->
            <div class="steam-card-actions">
                <button class="steam-action-btn" data-action="like" title="Like">
                    <i class="far fa-heart"></i>
                </button>
                <button class="steam-action-btn" data-action="add-playlist" title="Add to Playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <a href="{% url 'music:download' track.pk %}" 
                   class="steam-action-btn" 
                   data-action="download" 
                   title="Download"
                   onclick="event.stopPropagation()">
                    <i class="fas fa-download"></i>
                </a>
            </div>
            
            <!-- Play Overlay -->
            <div class="steam-play-overlay">
                <button class="steam-play-btn">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            
            <!-- Track Info -->
            <div class="steam-card-info">
                <h3 class="steam-card-title">{{ track.title }}</h3>
                <p class="steam-card-artist">{{ track.artist.name }}</p>
                <div class="steam-card-meta">
                    <span><i class="far fa-clock"></i> 3:45</span>
                    {% if forloop.counter0|divisibleby:3 %}
                    <span class="steam-card-badge">New</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Progress Bar (optional - for playing tracks) -->
            <!-- <div class="steam-card-progress">
                <div class="steam-card-progress-fill" style="width: 35%"></div>
            </div> -->
        </div>
        {% empty %}
        <!-- Empty State -->
        <div class="col-span-full flex flex-col items-center justify-center py-32 opacity-40">
            <i class="fas fa-music text-6xl mb-6"></i>
            <h3 class="text-2xl font-bold mb-2">No tracks found</h3>
            <p class="text-white/60 mb-6">Try adjusting your search or upload some music</p>
            <a href="{% url 'music:upload_page' %}" class="glass-red-tint glass-radius-xl glass-pressable px-6 py-3 font-semibold">
                <i class="fas fa-upload mr-2"></i>Upload Tracks
            </a>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Stats Bar -->
{% if music_files %}
<section class="max-w-[1920px] mx-auto mb-12" data-glass-context>
    <div class="glass-layer-2 glass-radius-2xl glass-specular-top p-8">
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="text-center">
                <div class="text-4xl font-black text-red-400 mb-2">{{ music_files|length }}</div>
                <div class="text-sm text-white/40 uppercase tracking-wider">Tracks</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-black text-red-400 mb-2">{{ all_artists|length }}</div>
                <div class="text-sm text-white/40 uppercase tracking-wider">Artists</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-black text-red-400 mb-2">
                    {% widthratio music_files|length 1 60 %}
                </div>
                <div class="text-sm text-white/40 uppercase tracking-wider">Hours</div>
            </div>
            <div class="text-center">
                <div class="text-4xl font-black text-red-400 mb-2">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="text-sm text-white/40 uppercase tracking-wider">HD Quality</div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Keyboard Shortcuts Info -->
<section class="max-w-[1920px] mx-auto mb-12" data-glass-context>
    <div class="glass-layer-1 glass-radius-xl p-6">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fas fa-keyboard text-red-400"></i>
            Keyboard Shortcuts
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div class="flex items-center gap-3">
                <kbd class="glass-layer-3 glass-radius-lg px-3 py-2 font-mono text-white/70 min-w-[3rem] text-center">Space</kbd>
                <span class="text-white/60">Play/Pause</span>
            </div>
            <div class="flex items-center gap-3">
                <kbd class="glass-layer-3 glass-radius-lg px-3 py-2 font-mono text-white/70 min-w-[3rem] text-center">←/→</kbd>
                <span class="text-white/60">Navigate</span>
            </div>
            <div class="flex items-center gap-3">
                <kbd class="glass-layer-3 glass-radius-lg px-3 py-2 font-mono text-white/70 min-w-[3rem] text-center">M</kbd>
                <span class="text-white/60">Mute</span>
            </div>
            <div class="flex items-center gap-3">
                <kbd class="glass-layer-3 glass-radius-lg px-3 py-2 font-mono text-white/70 min-w-[3rem] text-center">F</kbd>
                <span class="text-white/60">Fullscreen</span>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/steam-carousel.js' %}"></script>
<script>
// Redirect to player on card click
window.addEventListener('trackPlay', (e) => {
    const trackId = e.detail.trackId;
    if (trackId) {
        window.location.href = `/player/${trackId}/`;
    }
});

// Category filter (placeholder - implement with AJAX in production)
window.addEventListener('categoryChange', (e) => {
    const category = e.detail.category;
    console.log('Filter by category:', category);
    // TODO: Implement AJAX filtering
});

// Welcome toast for first-time users
if (!localStorage.getItem('steam_ui_tour')) {
    setTimeout(() => {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-8 right-8 glass-layer-3 glass-radius-xl glass-edge-light p-6 shadow-2xl z-50 max-w-md glass-animate-slide-right';
        toast.innerHTML = `
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-600 to-red-700 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-rocket text-white text-xl"></i>
                </div>
                <div class="flex-1">
                    <h4 class="font-bold text-lg mb-1">Welcome to Music Stream!</h4>
                    <p class="text-sm text-white/70 mb-3">
                        Hover over cards for quick actions. Use arrow keys to navigate carousels.
                    </p>
                    <button onclick="this.closest('div').closest('div').closest('div').remove(); localStorage.setItem('steam_ui_tour', 'true');" 
                            class="glass-red-tint glass-radius-lg glass-pressable px-4 py-2 text-sm font-semibold">
                        Got it!
                    </button>
                </div>
                <button onclick="this.closest('div').closest('div').remove()" class="text-white/40 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(toast);
    }, 2000);
}
</script>
{% endblock %}
